# mise configuration for Terraform project
# mise ã¯é–‹ç™ºç’°å¢ƒã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚’çµ±ä¸€çš„ã«ç®¡ç†ã—ã¾ã™
#
# ä½¿ã„æ–¹:
#   mise run help     - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º
#   mise run install  - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã¨pre-commit hooksï¼‰
#   mise run all      - ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ

[tools]
terraform = "1.13.2"
pre-commit = "latest"
tflint = "latest"
trivy = "latest"

[settings]
experimental = true

# =======================================================================
# Project Setup
# =======================================================================

[tasks.install]
description = "ä¾å­˜é–¢ä¿‚ã¨Git hooksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
alias = "setup"
run = """
#!/bin/bash
echo "ğŸš€ Setting up development environment..."
# Install mise tools
echo "ğŸ“¦ Installing tools..."
mise install
# Install pre-commit hooks
echo "ğŸª Installing pre-commit hooks..."
pre-commit install
echo "âœ… Setup complete!"
"""

# =======================================================================
# Code Quality Commands
# =======================================================================

[tasks.all]
description = "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆformat, validate, tflint, trivyï¼‰"
depends = ["format", "validate", "tflint", "trivy-fs", "trivy-config"]

[tasks.check-all]
description = "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ via pre-commit"
run = "pre-commit run --all-files"

[tasks.format]
description = "Terraformã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
run = "terraform fmt -check -recursive ."

[tasks."format:fix"]
description = "Terraformã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¿®æ­£ï¼‰"
run = "terraform fmt -recursive ."

[tasks.validate]
description = "Terraformè¨­å®šã‚’æ¤œè¨¼"
run = "terraform validate"

[tasks.tflint]
description = "TFLintã‚’å®Ÿè¡Œ"
run = "tflint --init && tflint --recursive"

[tasks.trivy-fs]
description = "Trivyãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ"
run = "trivy fs . -c .trivyconfig.yaml --ignorefile .trivyignore"

[tasks.trivy-config]
description = "Trivyè¨­å®šã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ"
run = "trivy config . -c .trivyconfig.yaml -s MEDIUM --ignorefile .trivyignore"

# =======================================================================
# pre-commit Commands
# =======================================================================

[tasks.pre-commit]
description = "pre-commitãƒã‚§ãƒƒã‚¯ã‚’æ‰‹å‹•å®Ÿè¡Œ"
run = "pre-commit run --all-files"

[tasks.pre-commit-update]
description = "pre-commitãƒ•ãƒƒã‚¯ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°"
run = "pre-commit autoupdate"

[tasks.pre-commit-uninstall]
description = "pre-commitãƒ•ãƒƒã‚¯ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
run = """
#!/bin/bash
echo "ğŸ—‘ï¸ Uninstalling pre-commit hooks..."
pre-commit uninstall
pre-commit uninstall --hook-type commit-msg
echo "âœ… Pre-commit hooks uninstalled!"
"""

[tasks.pre-commit-clean]
description = "pre-commitã‚’å®Œå…¨å‰Šé™¤ï¼ˆãƒ•ãƒƒã‚¯ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰"
run = """
#!/bin/bash
echo "ğŸ§¹ Completely removing pre-commit..."
# Uninstall hooks
pre-commit uninstall 2>/dev/null || true
pre-commit uninstall --hook-type commit-msg 2>/dev/null || true
pre-commit uninstall --hook-type pre-push 2>/dev/null || true
# Remove cache
rm -rf ~/.cache/pre-commit 2>/dev/null || true
echo "âœ… Pre-commit cache removed!"
"""

# =======================================================================
# Terraform Commands
# =======================================================================

[tasks.init]
description = "Terraformã‚’åˆæœŸåŒ–"
run = "terraform init"

[tasks.plan]
description = "Terraform planã‚’å®Ÿè¡Œ"
run = "terraform plan"

[tasks.apply]
description = "Terraform applyã‚’å®Ÿè¡Œ"
run = "terraform apply"

[tasks.destroy]
description = "Terraform destroyã‚’å®Ÿè¡Œ"
run = "terraform destroy"

[tasks.clean]
description = "Terraformã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
run = """
rm -rf .terraform/
rm -rf .terragrunt-cache/
rm -f terraform.tfstate*
rm -f .terraform.lock.hcl
"""
