# mise configuration for Python project
# mise ã¯é–‹ç™ºç’°å¢ƒã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚’çµ±ä¸€çš„ã«ç®¡ç†ã—ã¾ã™
#
# ä½¿ã„æ–¹:
#   mise run help     - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º
#   mise run install  - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã¨pre-commit hooksï¼‰
#   mise run dev      - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•

# Settings
[settings]
experimental = true

# Environment variables
[env]
_.python.venv = { path = ".venv", create = true }

# Tools configuration
[tools]
python = "3.13"
pre-commit = "latest"

# =======================================================================
# Project Setup
# =======================================================================

# Installation tasks
[tasks.install]
description = "ä¾å­˜é–¢ä¿‚ã¨Git hooksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
run = """
#!/bin/bash
echo "ğŸš€ Setting up development environment..."
# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
uv pip install -e .[dev]
# Install pre-commit hooks
echo "ğŸª Installing pre-commit hooks..."
pre-commit install
echo "âœ… Setup complete! Run 'mise run dev' to start"
"""

[tasks."install-prod"]
description = "æœ¬ç•ªç”¨ä¾å­˜é–¢ä¿‚ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
run = "uv pip install ."

# Development server
[tasks.dev]
description = "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
run = "python -m src.main"

# =======================================================================
# Test
# =======================================================================

# Testing tasks
[tasks.test]
description = "å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
run = "pytest"

[tasks."test:unit"]
description = "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œ"
run = "pytest -m unit"

[tasks."test:integration"]
description = "çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œ"
run = "pytest -m integration"

[tasks.coverage]
description = "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
run = "pytest --cov=src --cov-report=html --cov-report=term"

# =======================================================================
# Linter
# =======================================================================

# Code quality tasks
[tasks.format]
description = "ruffã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
run = "ruff format src/ tests/"

[tasks."format:check"]
description = "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯"
run = "ruff format --check src/ tests/"

[tasks.lint]
description = "ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"
run = """
ruff check src/ tests/
mypy src/
"""

[tasks."lint:fix"]
description = "ãƒªãƒ³ãƒˆå•é¡Œã‚’è‡ªå‹•ä¿®æ­£"
run = "ruff check --fix src/ tests/"

[tasks.typecheck]
description = "mypyã§å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"
run = "mypy src/"

[tasks.check]
description = "å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒªãƒ³ãƒˆã€å‹ãƒã‚§ãƒƒã‚¯ã€ãƒ†ã‚¹ãƒˆï¼‰"
depends = ["format:check", "lint:fix", "typecheck", "test"]

[tasks.check-all]
description = "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ via pre-commit"
run = "pre-commit run --all-files"

# =======================================================================
# pre-commit Commands
# =======================================================================

[tasks.pre-commit]
description = "pre-commitãƒã‚§ãƒƒã‚¯ã‚’æ‰‹å‹•å®Ÿè¡Œ"
run = "pre-commit run --all-files"

[tasks.pre-commit-update]
description = "pre-commitãƒ•ãƒƒã‚¯ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°"
run = "pre-commit autoupdate"

[tasks.pre-commit-uninstall]
description = "pre-commitãƒ•ãƒƒã‚¯ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
run = """
#!/bin/bash
echo "ğŸ—‘ï¸ Uninstalling pre-commit hooks..."
pre-commit uninstall
pre-commit uninstall --hook-type commit-msg
echo "âœ… Pre-commit hooks uninstalled!"
"""

[tasks.pre-commit-clean]
description = "pre-commitã‚’å®Œå…¨å‰Šé™¤ï¼ˆãƒ•ãƒƒã‚¯ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰"
run = """
#!/bin/bash
echo "ğŸ§¹ Completely removing pre-commit..."
# Uninstall hooks
pre-commit uninstall 2>/dev/null || true
pre-commit uninstall --hook-type commit-msg 2>/dev/null || true
pre-commit uninstall --hook-type pre-push 2>/dev/null || true
# Remove cache
rm -rf ~/.cache/pre-commit 2>/dev/null || true
echo "âœ… Pre-commit cache removed!"
"""

# =======================================================================
# Build & Cleanup
# =======================================================================

# Build tasks
#[tasks.build]
#description = "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
#run = "docker build -t image:local ."

# Cleanup tasks
[tasks.clean]
description = "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
run = """
rm -rf build/
rm -rf dist/
rm -rf *.egg-info
rm -rf .pytest_cache
rm -rf .ruff_cache
rm -rf .mypy_cache
rm -rf htmlcov/
rm -rf .coverage
find . -type d -name __pycache__ -exec rm -rf {} +
"""
