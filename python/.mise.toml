# Settings
[settings]
experimental = true

# Environment variables
[env]
_.python.venv = { path = ".venv", create = true }

# Tools configuration
[tools]
python = "3.13"
pre-commit = "latest"

# Hooks
[hooks]
postinstall = "uv pip install -e .[dev] && pre-commit install"

# =======================================================================
# Project Setup
# =======================================================================

# Installation tasks
[tasks.install]
description = "開発用依存関係とpre-commitフックをインストール"
run = "uv pip install -e .[dev] && pre-commit install"

[tasks."install-prod"]
description = "本番用依存関係のみをインストール"
run = "uv pip install ."

# Development server
[tasks.dev]
description = "開発サーバーを起動"
run = "python -m src.main"

# =======================================================================
# Test
# =======================================================================

# Testing tasks
[tasks.test]
description = "全てのテストを実行"
run = "pytest"

[tasks."test:unit"]
description = "ユニットテストのみを実行"
run = "pytest -m unit"

[tasks."test:integration"]
description = "統合テストのみを実行"
run = "pytest -m integration"

[tasks.coverage]
description = "カバレッジレポート付きでテストを実行"
run = "pytest --cov=src --cov-report=html --cov-report=term"

# =======================================================================
# Linter
# =======================================================================

# Code quality tasks
[tasks.format]
description = "ruffでコードをフォーマット"
run = "ruff format src/ tests/"

[tasks."format:check"]
description = "コードフォーマットをチェック"
run = "ruff format --check src/ tests/"

[tasks.lint]
description = "リントチェックを実行"
run = """
ruff check src/ tests/
mypy src/
"""

[tasks."lint:fix"]
description = "リント問題を自動修正"
run = "ruff check --fix src/ tests/"

[tasks.typecheck]
description = "mypyで型チェックを実行"
run = "mypy src/"

[tasks.check]
description = "全ての品質チェックを実行（フォーマット、リント、型チェック、テスト）"
depends = ["format:check", "lint:fix", "typecheck", "test"]

# =======================================================================
# Build
# =======================================================================

# Build tasks
#[tasks.build]
#description = "Dockerイメージをビルド"
#run = "docker build -t image:local ."


# Cleanup tasks
[tasks.clean]
description = "ビルド成果物とキャッシュをクリーンアップ"
run = """
rm -rf build/
rm -rf dist/
rm -rf *.egg-info
rm -rf .pytest_cache
rm -rf .ruff_cache
rm -rf .mypy_cache
rm -rf htmlcov/
rm -rf .coverage
find . -type d -name __pycache__ -exec rm -rf {} +
"""
